import os 
import sys 
import glob 
import shutil 
import joblib 

do_shap =False 

import runtime.external_assessor_LR as external_assessor_LR
import runtime.external_assessor_shap as external_assessor_shap
import runtime.external_assessor as external_assessor
import runtime.find_best as find_best

def get_serial_from_path (model_path ):
    """Extracts serial from filename (e.g., '.../model/05022026_123.pkl' -> '05022026_123')"""
    filename =os .path .basename (model_path )
    return filename .replace ('.pkl','')

def scan_models (outputs_dir ="outputs"):
    """Scans for valid .pkl models following structure: outputs/{SERIAL}/model/{SERIAL}.pkl"""

    search_pattern =os .path .join (outputs_dir ,"*","model","*.pkl")
    files =glob .glob (search_pattern )
    return sorted (files )

def move_outputs (serial ,target_base_dir ):
    """
    Moves the specific output folders generated by the modules 
    into the centralized 'external_assessor' folder.
    """


    source_map ={
    "baseline_comparison":"Logistic_Regression_Baseline",
    "shap_output":"SHAP_Analysis",
    "shap_analysis":"SHAP_Analysis",
    "external_assessment":"General_Performance",
    "model_assessment":"General_Performance"
    }

    target_dir =os .path .join (target_base_dir ,serial )
    os .makedirs (target_dir ,exist_ok =True )

    for src_name ,dest_name in source_map .items ():




        src_path_1 =os .path .join (src_name ,serial )


        src_path_2 =src_name 

        final_src =None 
        if os .path .exists (src_path_1 )and os .path .isdir (src_path_1 ):
            final_src =src_path_1 
        elif os .path .exists (src_path_2 )and os .path .isdir (src_path_2 ):


            final_src =src_path_2 

        if final_src :
            final_dest =os .path .join (target_dir ,dest_name )


            if os .path .exists (final_dest ):
                shutil .rmtree (final_dest )

            try :
                shutil .move (final_src ,final_dest )
                print (f"   -> Moved {src_name } to {final_dest }")


                parent =os .path .dirname (final_src )
                if os .path .exists (parent )and not os .listdir (parent )and parent !=".":
                    os .rmdir (parent )
            except Exception as e :
                print (f"   [WARN] Failed to move {src_name }: {e }")

def main ():

    OUTPUTS_DIR ="outputs"
    ASSESSOR_DIR ="external_assessor"

    if not os .path .exists (OUTPUTS_DIR ):
        print (f"[ERROR] 'outputs' folder not found in {os .getcwd ()}")
        return 

    os .makedirs (ASSESSOR_DIR ,exist_ok =True )


    models =scan_models (OUTPUTS_DIR )
    if not models :
        print (f"[WARN] No models found in {OUTPUTS_DIR }/{{SERIAL}}/model/*.pkl")
        return 

    print (f"\n[INFO] Found {len (models )} models to assess.")
    print ("="*60 )


    for i ,model_path in enumerate (models ,1 ):
        serial =get_serial_from_path (model_path )
        print (f"\n[{i }/{len (models )}] Processing Serial: {serial }")
        print (f"Path: {model_path }")
        print ("-"*40 )

        print ("   > Running Logistic Regression Assessor...")
        external_assessor_LR .main (model_path )

        if do_shap :
            print ("   > Running SHAP Analysis...")
            external_assessor_shap .main (model_path )

        print ("   > Running General External Assessor...")
        external_assessor .main (model_path )

        print ("   > Organizing output files...")
        move_outputs (serial ,ASSESSOR_DIR )
        print (f"   [DONE] Results saved to {ASSESSOR_DIR }/{serial }/")

    print ("\n"+"="*60 )
    print (f"Assessment Complete. All results are in '{ASSESSOR_DIR }/'")

    print('now running bestie finder')
    
    find_best.main(folder_path="./external_assessor/metrics/")

if __name__ =="__main__":
    main ()