"""
TearSense Model Assessment Pipeline
═══════════════════════════════════════════════════════════════════════════

Runs external assessment on all models, finds the best one, then:
1. Runs logistic_regressioner.py (if LR analysis doesn't exist)
2. Runs combiner.py (generates combined comparison plots)

Usage:
    python run.py
"""

import os 
import sys 
import glob 
import shutil 
import joblib 
import pandas as pd

do_shap = False 

# Import runtime modules
import runtime.external_assessor_LR as external_assessor_LR
import runtime.external_assessor_shap as external_assessor_shap
import runtime.external_assessor as external_assessor
import runtime.find_best as find_best


def get_serial_from_path(model_path):
    """Extracts serial from filename (e.g., '.../model/05022026_123.pkl' -> '05022026_123')"""
    filename = os.path.basename(model_path)
    return filename.replace('.pkl', '')


def scan_models(outputs_dir="outputs"):
    """Scans for valid .pkl models following structure: outputs/{SERIAL}/model/{SERIAL}.pkl"""
    search_pattern = os.path.join(outputs_dir, "*", "model", "*.pkl")
    files = glob.glob(search_pattern)
    return sorted(files)


def move_outputs(serial, target_base_dir):
    """
    Moves the specific output folders generated by the modules 
    into the centralized 'external_assessor' folder.
    """
    source_map = {
        "baseline_comparison": "Logistic_Regression_Baseline",
        "shap_output": "SHAP_Analysis",
        "shap_analysis": "SHAP_Analysis",
        "external_assessment": "General_Performance",
        "model_assessment": "General_Performance",
        "combined_analysis": "Combined_Analysis"
    }

    target_dir = os.path.join(target_base_dir, serial)
    os.makedirs(target_dir, exist_ok=True)

    for src_name, dest_name in source_map.items():
        # Check both {src_name}/{serial} and {src_name} directly
        src_path_1 = os.path.join(src_name, serial)
        src_path_2 = src_name

        final_src = None
        if os.path.exists(src_path_1) and os.path.isdir(src_path_1):
            final_src = src_path_1
        elif os.path.exists(src_path_2) and os.path.isdir(src_path_2):
            final_src = src_path_2

        if final_src:
            final_dest = os.path.join(target_dir, dest_name)

            if os.path.exists(final_dest):
                shutil.rmtree(final_dest)

            try:
                shutil.move(final_src, final_dest)
                print(f"   -> Moved {src_name} to {final_dest}")

                # Clean up empty parent directory
                parent = os.path.dirname(final_src)
                if os.path.exists(parent) and not os.listdir(parent) and parent != ".":
                    os.rmdir(parent)
            except Exception as e:
                print(f"   [WARN] Failed to move {src_name}: {e}")


def get_best_serial(metrics_folder="./external_assessor/metrics/"):
    """
    Reads the model_rankings_full.csv to get the best model serial.
    Returns the serial number of the best ranked model.
    """
    rankings_path = os.path.join(metrics_folder, "model_rankings_full.csv")
    
    if not os.path.exists(rankings_path):
        print(f"[WARN] Rankings file not found: {rankings_path}")
        return None
    
    try:
        df = pd.read_csv(rankings_path)
        if df.empty:
            return None
        # Best model is first row (sorted by Mean Rank ascending)
        best_serial = df.iloc[0]['Model Serial']
        return str(best_serial)
    except Exception as e:
        print(f"[ERROR] Failed to read rankings: {e}")
        return None


def check_lr_exists(serial, assessor_dir="external_assessor"):
    """
    Check if logistic regression analysis already exists for this serial.
    Looks for lr_metrics.json or lr_coefficients.csv in various locations.
    """
    check_paths = [
        os.path.join(assessor_dir, serial, "Logistic_Regression_Baseline", "lr_metrics.json"),
        os.path.join(assessor_dir, serial, "Logistic_Regression_Baseline", "lr_coefficients.csv"),
        os.path.join(assessor_dir, serial, "lr", "lr_metrics.json"),
        os.path.join("baseline_comparison", serial, "lr_metrics.json"),
    ]
    
    return any(os.path.exists(p) for p in check_paths)


def check_combined_exists(serial, assessor_dir="external_assessor"):
    """
    Check if combined analysis already exists for this serial.
    Looks for combined_auroc.png or combined_metrics.json.
    """
    check_paths = [
        os.path.join(assessor_dir, serial, "Combined_Analysis", "combined_auroc.png"),
        os.path.join(assessor_dir, serial, "Combined_Analysis", "combined_metrics.json"),
        os.path.join("combined_analysis", serial, "combined_auroc.png"),
    ]
    
    return any(os.path.exists(p) for p in check_paths)


def run_logistic_regressioner(model_path):
    """
    Run logistic_regressioner.py on the given model.
    Tries to import and run it dynamically.
    """
    try:
        # Try importing from current directory
        if os.path.exists("logistic_regressioner.py"):
            import importlib.util
            spec = importlib.util.spec_from_file_location("logistic_regressioner", "logistic_regressioner.py")
            lr_module = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(lr_module)
            lr_module.main(model_path)
            return True
        else:
            print("[WARN] logistic_regressioner.py not found in current directory.")
            return False
    except Exception as e:
        print(f"[ERROR] Logistic Regressioner failed: {e}")
        import traceback
        traceback.print_exc()
        return False


def run_combiner(model_path):
    """
    Run combiner.py on the given model.
    Tries to import and run it dynamically.
    """
    try:
        # Try importing from runtime directory
        if os.path.exists("runtime/combiner.py"):
            import importlib.util
            spec = importlib.util.spec_from_file_location("combiner", "runtime/combiner.py")
            combiner_module = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(combiner_module)
            combiner_module.main(model_path)
            return True
        # Try importing from current directory
        elif os.path.exists("combiner.py"):
            import importlib.util
            spec = importlib.util.spec_from_file_location("combiner", "combiner.py")
            combiner_module = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(combiner_module)
            combiner_module.main(model_path)
            return True
        else:
            print("[WARN] combiner.py not found in runtime/ or current directory.")
            return False
    except Exception as e:
        print(f"[ERROR] Combiner failed: {e}")
        import traceback
        traceback.print_exc()
        return False


def run_best_model_analysis(best_serial, outputs_dir="outputs", assessor_dir="external_assessor"):
    """
    Runs logistic_regressioner and combiner on the best model if not already done.
    """
    print("\n" + "=" * 70)
    print("  BEST MODEL ANALYSIS: Logistic Regression + Combined Plots")
    print("=" * 70)
    print(f"  Best Model Serial: {best_serial}")
    
    model_path = os.path.join(outputs_dir, best_serial, "model", f"{best_serial}.pkl")
    
    if not os.path.exists(model_path):
        print(f"[ERROR] Best model not found: {model_path}")
        return
    
    # Check what already exists
    lr_exists = check_lr_exists(best_serial, assessor_dir)
    combined_exists = check_combined_exists(best_serial, assessor_dir)
    
    # ═══════════════════════════════════════════════════════════════════════
    # Run Logistic Regressioner (if needed)
    # ═══════════════════════════════════════════════════════════════════════
    if not lr_exists:
        print(f"\n[STEP 1] Running Logistic Regression analysis...")
        print(f"         Model: {model_path}")
        success = run_logistic_regressioner(model_path)
        if success:
            print("[DONE] Logistic Regression analysis complete.")
        else:
            print("[SKIP] Logistic Regression analysis could not be run.")
    else:
        print(f"\n[STEP 1] Logistic Regression analysis already exists. Skipping.")
    
    # ═══════════════════════════════════════════════════════════════════════
    # Run Combiner (generates combined AUROC, Calibration, DCA plots)
    # ═══════════════════════════════════════════════════════════════════════
    if not combined_exists:
        print(f"\n[STEP 2] Running Combined Analysis (TearSense vs LR plots)...")
        print(f"         Model: {model_path}")
        success = run_combiner(model_path)
        if success:
            print("[DONE] Combined Analysis complete.")
        else:
            print("[SKIP] Combined Analysis could not be run.")
    else:
        print(f"\n[STEP 2] Combined Analysis already exists. Skipping.")
    
    # ═══════════════════════════════════════════════════════════════════════
    # Move outputs to external_assessor directory
    # ═══════════════════════════════════════════════════════════════════════
    print(f"\n[STEP 3] Organizing best model outputs...")
    move_outputs(best_serial, assessor_dir)
    
    print("\n" + "=" * 70)
    print(f"  ✓ Best model analysis complete!")
    print(f"  ✓ Results saved to: {assessor_dir}/{best_serial}/")
    print("=" * 70)


def main():
    OUTPUTS_DIR = "outputs"
    ASSESSOR_DIR = "external_assessor"

    if not os.path.exists(OUTPUTS_DIR):
        print(f"[ERROR] 'outputs' folder not found in {os.getcwd()}")
        return

    os.makedirs(ASSESSOR_DIR, exist_ok=True)

    # ═══════════════════════════════════════════════════════════════════════
    # PHASE 1: Run external assessment on all models
    # ═══════════════════════════════════════════════════════════════════════
    models = scan_models(OUTPUTS_DIR)
    if not models:
        print(f"[WARN] No models found in {OUTPUTS_DIR}/{{SERIAL}}/model/*.pkl")
        return

    print(f"\n[INFO] Found {len(models)} models to assess.")
    print("=" * 60)

    for i, model_path in enumerate(models, 1):
        serial = get_serial_from_path(model_path)
        print(f"\n[{i}/{len(models)}] Processing Serial: {serial}")
        print(f"Path: {model_path}")
        print("-" * 40)

        print("   > Running Logistic Regression Assessor...")
        # external_assessor_LR.main(model_path)

        if do_shap:
            print("   > Running SHAP Analysis...")
            external_assessor_shap.main(model_path)

        print("   > Running General External Assessor...")
        external_assessor.main(model_path)

        print("   > Organizing output files...")
        move_outputs(serial, ASSESSOR_DIR)
        print(f"   [DONE] Results saved to {ASSESSOR_DIR}/{serial}/")

    print("\n" + "=" * 60)
    print(f"Phase 1 Complete: All models assessed.")
    print(f"Results saved to '{ASSESSOR_DIR}/'")

    # ═══════════════════════════════════════════════════════════════════════
    # PHASE 2: Find the best model
    # ═══════════════════════════════════════════════════════════════════════
    print("\n" + "=" * 60)
    print("PHASE 2: Finding Best Model")
    print("=" * 60)
    
    find_best.main(folder_path="./external_assessor/metrics/")
    
    # ═══════════════════════════════════════════════════════════════════════
    # PHASE 3: Run LR + Combiner on best model
    # ═══════════════════════════════════════════════════════════════════════
    best_serial = get_best_serial("./external_assessor/metrics/")
    
    if best_serial:
        print("\n" + "=" * 60)
        print("PHASE 3: Best Model Deep Analysis")
        print("=" * 60)
        run_best_model_analysis(best_serial, OUTPUTS_DIR, ASSESSOR_DIR)
    else:
        print("[WARN] Could not determine best model. Skipping Phase 3.")

    # ═══════════════════════════════════════════════════════════════════════
    # FINAL SUMMARY
    # ═══════════════════════════════════════════════════════════════════════
    print("\n" + "=" * 70)
    print("  PIPELINE COMPLETE")
    print("=" * 70)
    print(f"  Models assessed: {len(models)}")
    if best_serial:
        print(f"  Best model: {best_serial}")
        print(f"  Best model outputs: {ASSESSOR_DIR}/{best_serial}/")
        print(f"    - General_Performance/")
        print(f"    - Logistic_Regression_Baseline/")
        print(f"    - Combined_Analysis/  (AUROC, Calibration, DCA comparison plots)")
    print("=" * 70)


if __name__ == "__main__":
    main()